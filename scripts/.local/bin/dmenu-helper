#!/usr/bin/env bash

usage() {
    echo "$(basename "$0") : dmenu helper script"
    echo " Possible operations: "
    echo "  run_menu    : Runs dmenu with the custom style and a supplied prompt message."
    echo "  get_options : Gets command-line options that are passed to dmenu."
    echo "  custom_menu : Runs dmenu with additional options apart from the custom style and prompt message."
}

get_options() {
    mapfile -t DIMENSIONS < <( polybar-helper get_dimensions )
    echo "-x ${DIMENSIONS[0]} -y ${DIMENSIONS[1]} -lh ${DIMENSIONS[2]} -z ${DIMENSIONS[3]}"
}

polybar_control() {
    polybar-helper disable >/dev/null 2>&1
    trap "polybar-helper enable >/dev/null 2>&1" EXIT
}

menu() {
    if [ "$3" != "" ]; then
        LINES="$3"
    elif [ -p /dev/stdin ]; then
        LINES="$( cat )"
    fi
    echo -e "$LINES" | dmenu $1 -p "$2" | tail -1
}

case $1 in
    run_menu) polybar_control; menu "$( get_options )" "$2" "$3"; exit 0;;
    get_options) get_options; exit 0;;
    custom_menu) polybar_control; menu "$( get_options ) $2" "$3" "$4"; exit 0;;
    *) echo "Unknown operation: $1"; usage; exit 1;;
esac
