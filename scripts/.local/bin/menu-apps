#!/usr/bin/env bash

# A frecency-based menu for launching applications.

# Global configuration
DEPENDENCIES=(gtk-launch notify-send menu mapfile)
CACHE_PATH="${XDG_CACHE_HOME:="$HOME/.cache"}/menuapps_history"
PATHS_INCLUDE=("${XDG_DATA_HOME:="$HOME/.local/share/"}/applications" "/usr/share/applications")
PATHS_EXCLUDE=("/tmp")

usage() {
    cat << EOF
Usage: $(basename "$0") OPERATION [APP]

A frecency-based menu for applications.

Operations:
    rebuild         Discard history and regenerate application index.
    refresh         Refresh the application index without discarding history.
    launch [APP]    Launch an application. If APP is omitted, prompts for selection.

Examples:
    $(basename "$0") rebuild
    $(basename "$0") refresh
    $(basename "$0") launch
    $(basename "$0") launch firefox
EOF
}

# Check for required dependencies
check_dependencies() {
    for DEPENDENCY in "${DEPENDENCIES[@]}"; do
        type -p "$DEPENDENCY" &> /dev/null || {
            echo "error: Could not find '${DEPENDENCY}', is it installed?" >&2
            exit 1
        }
    done
}

# Generate a list of available applications in frecency format
#
# Outputs:
#   Lines in the format '00000.0000000000 appname'
get_apps() {
    local APPS_LIST=()
    for PATH_INCLUDE in "${PATHS_INCLUDE[@]}"; do
        while IFS=$'\n' read -r ENTRY; do
            ENTRY="${ENTRY##*/}"
            APPS_LIST+=("${ENTRY::-8}")
        done < <(find "$PATH_INCLUDE" -iname "*.desktop" 2> /dev/null)
    done
    for PATH_EXCLUDE in "${PATHS_EXCLUDE[@]}"; do
        for ENTRY_IDX in "${!APPS_LIST[@]}"; do
            if [[ ${APPS_LIST[$ENTRY_IDX]} == $PATHS_EXCLUDE* ]]; then
                unset 'APPS_LIST[ENTRY_IDX]'
            fi
        done
    done
    printf '%s\n' "${APPS_LIST[@]}" | xargs -n 1 echo "00000.0000000000"
}

# Find new applications not present in the cache
#
# Outputs:
#   Lines in the format '00000.0000000000 appname'
get_new_apps() {
    comm -23 <(get_apps | cut -f -2 -d " " | sort | uniq | sort) <(cut -f 2- -d " " "$CACHE_PATH" | sort | uniq | sort) | xargs -n 1 echo "00000.0000000000"
}

# Rebuild the application cache from scratch
rebuild_cache() {
    rm -f "$CACHE_PATH" 2> /dev/null
    get_apps > "$CACHE_PATH"
    notify-send -u low "Cache created at $CACHE_PATH!"
}

# Refresh the application cache, keeping existing history
refresh_cache() {
    local UPDATED_CACHE
    UPDATED_CACHE="$(echo -e "$(get_new_apps)\n$(cat "$CACHE_PATH")" | sort -nr)"
    echo "$UPDATED_CACHE" > "$CACHE_PATH"
}

# Launch an application and update its frecency in the cache
#
# Arguments:
#   $1 - The application to launch. If omitted, prompts for selection.
launch_application() {
    if [ ! -f "$CACHE_PATH" ]; then
        notify-send -u normal "No frecency cache found! Run $(basename "$0") rebuild to generate the cache first!"
        exit 1
    elif [[ ! -s $CACHE_PATH ]]; then
        notify-send -u normal "Frecency cache is empty! Run $(basename "$0") rebuild to generate the cache first!"
        exit 1
    fi
    mapfile -t APP_ENTRIES_LIST < <(cut -f 2- -d " " "$CACHE_PATH")
    local SELECTED_APP
    if [[ " ${APP_ENTRIES_LIST[*]} " =~ " $1 " ]]; then
        SELECTED_APP="$1"
    elif [[ -z $1 ]]; then
        SELECTED_APP="$(menu run -p " ó°€»  " <<< "$(printf "%s\n" "${APP_ENTRIES_LIST[@]}")")"
        if [[ -z $SELECTED_APP ]]; then
            notify-send -u normal "Empty input!"
            exit 2
        elif [[ ! " ${APP_ENTRIES_LIST[*]} " =~ " $SELECTED_APP " ]]; then
            notify-send -u normal "Invalid application specified!"
            exit 2
        fi
    else
        notify-send -u normal "Invalid application specified!"
        exit 2
    fi
    local SELECTED_APP_ENTRY
    SELECTED_APP_ENTRY="$(grep -E "^[0-9]{5}\\.[0-9]{10} ${SELECTED_APP}$" "$CACHE_PATH")"
    local SELECTED_APP_FREQ
    SELECTED_APP_FREQ="$(printf %05.0f $((10#${SELECTED_APP_ENTRY:0:5} + 1)))"
    local SELECTED_APP_LAST_LAUNCH
    SELECTED_APP_LAST_LAUNCH="$(date +%s)"
    gtk-launch "$SELECTED_APP"
    local UPDATED_CACHE_CONTENT
    UPDATED_CACHE_CONTENT="$(echo -e "$(grep -v "^$SELECTED_APP_ENTRY$" "$CACHE_PATH")\n$SELECTED_APP_FREQ.$SELECTED_APP_LAST_LAUNCH $SELECTED_APP" | sort -nr | uniq | sort -nr)"
    echo -e "$UPDATED_CACHE_CONTENT" > "$CACHE_PATH"
}

# Main entry point
main() {
    check_dependencies
    case "$1" in
        rebuild)
            rebuild_cache
            ;;
        refresh)
            refresh_cache
            ;;
        launch)
            launch_application "$2"
            ;;
        -h | --help)
            usage
            ;;
        *)
            echo "Unknown operation: $1"
            usage
            ;;
    esac
}

main "$@"
