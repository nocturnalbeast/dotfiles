#!/usr/bin/env bash

# A helper script for managing spectrwm region configuration.

# Global configuration
SPECTRWM_CONFIG_PATH="${XDG_CONFIG_HOME:="$HOME/.config"}/spectrwm/spectrwm.conf"
DEPENDENCIES=(xdpyinfo awk sed polybarctl spectrwm)

usage() {
    cat << EOF
Usage: $(basename "$0") [OPTION]

A helper script for managing spectrwm region configuration.

Options:
    disable_padding    Disable padding and reserve no space for polybar
    -h, --help         Show this help message

If no option is provided, region configuration will include polybar padding.
EOF
}

# Check for required dependencies
check_dependencies() {
    for dependency in "${DEPENDENCIES[@]}"; do
        if ! command -v "$dependency" &> /dev/null; then
            echo "error: Could not find '${dependency}', is it installed?" >&2
            return 1
        fi
    done
}

# Get screen resolutions
#
# Outputs:
#   Writes resolution lines to stdout
get_resolutions() {
    xdpyinfo | awk '/dimensions/{print $2}'
}

# Extract spacing from spectrwm config
#
# Outputs:
#   Writes spacing components to stdout
get_spacing() {
    sed -n "s/^\([ ]*\)region\([ ]*\)=\([ ]*\)screen\[[0-9]*\]:.*$/\1:\2:\3/p" "$SPECTRWM_CONFIG_PATH" | head -1
}

# Get polybar dimensions
#
# Outputs:
#   Writes polybar dimensions to stdout
get_bar_dimensions() {
    polybarctl get_dimensions
}

# Get region padding from spectrwm config
#
# Outputs:
#   Writes region padding value to stdout
get_region_padding() {
    awk -F "=" '/^[ ]*region_padding/ {print $2}' "$SPECTRWM_CONFIG_PATH" | tr -d ' '
}

# Generate region lines for disable_padding mode
#
# Arguments:
#   $1 - Spacing prefix
#   $2 - Spacing separator
#   $3 - Spacing suffix
#   $4 - Array of resolutions
#
# Outputs:
#   Writes region lines to stdout
generate_disable_padding_regions() {
    local spacing_prefix="$1"
    local spacing_separator="$2"
    local spacing_suffix="$3"
    shift 3
    local resolutions=("$@")
    local idx=1

    for resolution in "${resolutions[@]}"; do
        echo "${spacing_prefix}region${spacing_separator}=${spacing_suffix}screen[$((idx++))]:${resolution}+0+0"
    done
}

# Generate region lines with polybar padding
#
# Arguments:
#   $1 - Spacing prefix
#   $2 - Spacing separator
#   $3 - Spacing suffix
#   $4 - Array of resolutions
#   $5 - Effective bar height
#
# Outputs:
#   Writes region lines to stdout
generate_padding_regions() {
    local spacing_prefix="$1"
    local spacing_separator="$2"
    local spacing_suffix="$3"
    local effective_bar_height="$5"
    shift 3
    local resolutions=("$@")

    for idx in "${!resolutions[@]}"; do
        local res_height
        local res_width
        local allowed_height
        local screen_idx

        res_height=$(echo "${resolutions[$idx]}" | cut -f 2 -d 'x')
        res_width=$(echo "${resolutions[$idx]}" | cut -f 1 -d 'x')
        allowed_height=$((res_height - effective_bar_height))
        screen_idx=$((idx + 1))

        echo "${spacing_prefix}region${spacing_separator}=${spacing_suffix}screen[${screen_idx}]:${res_width}x${allowed_height}+0+${effective_bar_height}"
    done
}

# Replace region lines in spectrwm config
#
# Arguments:
#   $1 - Array of region lines to insert
update_config() {
    local region_lines=("$@")
    local replace_line_nr
    local temp_file

    replace_line_nr=$(grep -n "^[ ]*region[ ]*=[ ]*screen\[[0-9]*\]:.*$" "$SPECTRWM_CONFIG_PATH" | cut -d : -f 1 | head -1)

    sed -i '/^[ ]*region[ ]*=[ ]*screen\[[0-9]*\]:.*$/d' "$SPECTRWM_CONFIG_PATH"

    for ((idx = ${#region_lines[@]} - 1; idx >= 0; idx--)); do
        temp_file=$(mktemp)
        awk -v n="$replace_line_nr" -v s="${region_lines[idx]}" 'NR == n {print s} {print}' "$SPECTRWM_CONFIG_PATH" > "$temp_file"
        mv "$temp_file" "$SPECTRWM_CONFIG_PATH"
    done
}

# Restart spectrwm to reload configuration
restart_spectrwm() {
    kill -1 "$(pidof spectrwm)"
}

# Main entry point
main() {
    case "$1" in
        disable_padding)
            check_dependencies && {
                local resolutions
                local spacing_components
                local region_lines=()

                mapfile -t resolutions < <(get_resolutions)
                IFS=$':' read -r spacing_prefix spacing_separator spacing_suffix < <(get_spacing)

                mapfile -t region_lines < <(generate_disable_padding_regions "$spacing_prefix" "$spacing_separator" "$spacing_suffix" "${resolutions[@]}")
                update_config "${region_lines[@]}"
                restart_spectrwm
            }
            ;;
        -h | --help)
            usage
            ;;
        *)
            check_dependencies && {
                local resolutions
                local spacing_components
                local bar_dimensions
                local region_padding
                local total_bar_height
                local effective_bar_height
                local region_lines=()

                mapfile -t resolutions < <(get_resolutions)
                IFS=$':' read -r spacing_prefix spacing_separator spacing_suffix < <(get_spacing)
                mapfile -t bar_dimensions < <(get_bar_dimensions)
                region_padding=$(get_region_padding)

                total_bar_height=$((${bar_dimensions[2]} + 2 * ${bar_dimensions[1]}))
                effective_bar_height=$((total_bar_height - region_padding))

                mapfile -t region_lines < <(generate_padding_regions "$spacing_prefix" "$spacing_separator" "$spacing_suffix" "${resolutions[@]}" "$effective_bar_height")
                update_config "${region_lines[@]}"
                restart_spectrwm
            }
            ;;
    esac
}

main "$@"
